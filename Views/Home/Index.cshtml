@model WebApplication3.Models.GoodStocks
@{
    ViewData["Title"] = "Home Page";
}

@section styles{

    <style>
        .header {
            font-family: sans-serif;
            color: white;
            font-size: 20px;
            text-align: center;
        }

        .box {
            margin-bottom: 10px;
        }

        .point {
            font-size: 4em;
            color: red;
        }

        .keyword {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px 12px;
            height: 38px;
            color: black;
        }

        .search {
            background-color: red;
            height: 38px;
            width: 120px;
            border-radius: 4px;
            border: 1px solid red;
            padding: 3px 12px;
            margin-left: 5px;
        }

        #total_float {
            position: fixed;
            top: 80vh;
            left: 90vw;
            height: 100px;
            width: 100px;
            border-radius: 99%;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background-color: red
        }


        #total_grade {
            text-align: center;
            padding-top: 23px;
            font-size: 35px;
            text-decoration: underline;
        }

        @@media (max-width: 1200px) {
            #total_float {
                left: 70vw;
            }

            .layoutLoading {
                left: 70vw;
            }
        }


        .info_box {
            text-align: center;
            font-size: 1em;
            background-color: #121212;
            margin-top: 40px;
            padding: 10px 30px 10px 30px;
            min-height: 264px;
        }

            .info_box > .show_edfri {
                margin-bottom: 10px;
                border-radius: 8px;
                background-color: #e9bcbc;
                font-size: 5.5em;
                text-shadow: 6px 6px 0px rgba(0, 0, 0, 0.2);
            }

            .info_box > p.title {
                font-weight: bold;
            }

            .info_box > p.describe {
                color: #9e9e9e;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

        .info_detail {
            font-size: 1em;
            background-color: #121212;
            margin-top: 40px;
            padding: 10px 30px 10px 30px;
            min-height: 264px;
            display: flex;
            align-items: center;
        }

            .info_detail > .grade {
                font-size: 5.5em;
                text-align: center;
                color: #e9bcbc;
            }

            .info_detail > .rule {
                color: #9e9e9e;
                text-align: left;
            }

                .info_detail > .rule > ul {
                    list-style-type: decimal;
                }

        a.detail {
            color: red;
            text-decoration: underline;
        }

        .overLoading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            opacity: 0.5;
            z-index: 1000;
        }

        .layoutLoading {
            display: none;
            position: absolute;
            top: 30vh;
            left: 40vw;
            width: 20vw;
            height: 20vh;
            z-index: 1001;
            text-align: center;
        }
    </style>
}
@section scripts{
    <script>
        $(function () {
            // declare variable
            var base = 0;
            var stockData = {
                year: [],
                e_arr: [],
                d_arr: [],
                f_arr: [],
                r_arr: [],
                i_arr: []
            };

            // register event
            $("input#search").on("click", function () {
                var keyword = $("input.keyword").val();
                if (keyword == "") {
                    alert("請輸入欲查詢代號!!");
                    $("input.keyword").focus()
                } else {
                    stockData = {
                        year: [],
                        e_arr: [],
                        d_arr: [],
                        f_arr: [],
                        r_arr: [],
                        i_arr: []
                    };
                    showLoading(true);
                    console.log('click search:', new Date())
                    $.ajax({
                        method: "GET",
                        url: "/Home/queryStock/" + $("input.keyword").val(),
                        //data: $("input.keyword").val(),
                        //contentType: "",

                        success: function (data) {
                            console.log('result back:', new Date())
                            console.log(data);
                            var total_grade = 0;
                            total_grade += E_chk(data.resultdt);
                            total_grade += D_chk(data.resultdt);
                            total_grade += F_chk(data.resultdt);
                            total_grade += R_chk(data.resultdt);
                            total_grade += I_chk(data.resultdt);
                            $("#total_float").show();
                            $("#total_grade").html(roundDecimal(total_grade, 1));
                            stockData.year.reverse();
                            showLoading(false);
                        },
                        error: function (thrownError) {
                            console.log(thrownError);
                        }
                    })
                }
            })
            $("a.detail").on("click", function () {
                var ctx = $("#stockDataChart");
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: stockData.year,
                        datasets: [{
                            label: $(this).parent().siblings()[1].innerHTML,
                            data: (function (target) {
                                console.log(stockData);
                                switch (target) {
                                    case 'E':
                                        return stockData.e_arr;
                                        break;
                                    case 'D':
                                        return stockData.d_arr;
                                        break;
                                    case 'F':
                                        return stockData.f_arr;
                                        break;
                                    case 'R':
                                        return stockData.r_arr;
                                        break;
                                    case 'I':
                                        return stockData.i_arr;
                                        break;
                                    default:
                                        return null;
                                }
                            })($(this).parent().siblings()[0].innerHTML),
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }

                });
            })

            // define func

            /**
             * Subject: EPS calculate
             * Description: 迴圈計算陣列，當前的數值大於後一個就給1分，再除以總數(有幾筆)
             */
            var E_chk = function (dt) {
                var count = 0;
                var basecnt = 0
                for (var i = 0; i < dt.length - 1; i++) {
                    stockData.e_arr.push(dt[i].eps);
                    if (dt[i].exist) {
                        basecnt++;
                        if (dt[i].eps > dt[i + 1].eps)
                            count++;
                    }
                }
                stockData.e_arr.push(dt[dt.length - 1].eps);
                if (dt[dt.length - 1].exist) basecnt++;
                base = basecnt;
                $("div#E_row div.grade").html("+" + roundDecimal(count / basecnt, 2));
                stockData.e_arr.reverse();
                return roundDecimal(count / basecnt, 2);
            }

            /**
             * Subject: Diviend calculate
             * Description: 迴圈計算陣列，當前的數值大於後一個就給1分，再除以總數(有幾筆)
             */
            var D_chk = function (dt) {
                var count = 0;
                var basecnt = 0
                var dividend_now = 0;
                var dividend_last = 0
                for (var i = 0; i < dt.length - 1; i++) {
                    dividend_now = 0;
                    dividend_last = 0
                    if (dt[i].exist) {
                        basecnt++;
                        if (dt[i].eps != 0)
                            dividend_now = Math.round(dt[i].dividend / dt[i].eps * 10000) / 100.00;
                        if (dt[i+1].eps != 0)
                            dividend_last = Math.round(dt[i + 1].dividend / dt[i + 1].eps * 10000) / 100.00;
                        if (dividend_now > dividend_last && dividend_now < 100)
                            count++;
                    }
                    stockData.d_arr.push(dividend_now);
                }
                if (dt[dt.length - 1].eps!=0)
                    stockData.d_arr.push(Math.round(dt[dt.length - 1].dividend / dt[dt.length - 1].eps * 10000) / 100.00);
                if (dt[dt.length - 1].exist) basecnt++;
                $("div#D_row div.grade").html("+" + roundDecimal(count / basecnt, 2));
                stockData.d_arr.reverse();
                return roundDecimal(count / basecnt, 2);
            }

            /**
             * Subject: FreeCachFlow calculate
             * Description: 迴圈計算陣列，當前的數值大於後一個就給1分，再除以總數(有幾筆)
             */
            var F_chk = function (dt) {
                var count = 0;
                var basecnt = 0
                for (var i = 0; i < dt.length; i++) {
                    stockData.f_arr.push(dt[i].netCashFlow);
                    if (dt[i].exist) {
                        basecnt++;
                        if (dt[i].netCashFlow > 0)
                            count++;
                    }
                }
                $("div#F_row div.grade").html("+" + roundDecimal(count / basecnt, 2));
                stockData.f_arr.reverse();
                return roundDecimal(count / basecnt, 2);
            }

            /**
             * Subject: ROE calculate
             * Description: 迴圈計算陣列，當前的數值大於後一個就給1分，再除以總數(有幾筆)
             */
            var R_chk = function (dt) {
                var count = 0;
                var ROE = 0;
                var basecnt = 0
                for (var i = 0; i < dt.length; i++) {
                    ROE = 0;
                    if (dt[i].shareholderEQU != 0)
                        ROE = Math.round(dt[i].netIncome / dt[i].shareholderEQU * 10000) / 100.00;
                    stockData.r_arr.push(ROE);
                    stockData.year.push(dt[i].year);
                    if (dt[i].exist) {
                        basecnt++;
                        if (ROE > 15 && ROE < 30)
                            count++;
                    }
                }
                $("div#R_row div.grade").html("+" + roundDecimal(count / basecnt, 2));
                stockData.r_arr.reverse();
                return roundDecimal(count / basecnt, 2);
            }

            /**
             * Subject: Interest calculate
             * Description: 淨收入/利息，再除以總數(有幾筆)
             */
            var I_chk = function (dt) {
                var count = 0;
                var IC = 0;
                IC = dt[0].netIncome / dt[0].interest;
                switch (true) {
                    case IC > 4:
                        count = 1;
                        break;
                    case IC > 10:
                        count = 0.5;
                        break;
                    default:
                        count = 0;
                }
                console.log('I:', count);
                $("div#I_row div.grade").html("+" + roundDecimal(count / base, 2));
                return roundDecimal(count / base, 2);
            }

            /**
             * Subject: 處理js除法錯誤問題
             */
            var roundDecimal = function (val, precision) {
                return Math.round(Math.round(val * Math.pow(10, (precision || 0) + 1)) / 10) / Math.pow(10, (precision || 0));
            }

            /**
             * Subject: loading圖示顯示
             */
            function showLoading(show) {
                if (show) {
                    document.getElementById("over").style.display = "block";
                    document.getElementById("layout").style.display = "block";
                } else {
                    document.getElementById("over").style.display = "none";
                    document.getElementById("layout").style.display = "none";
                }
            }

            /**
             * Subject: 初始化
             */
            function init() {
                $("#total_float").hide();
            }


            // main program start here.
            init();

        });

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.0/Chart.min.js"></script>

}
<div class="header">

    <div class="box point">StockScore <span style="color: white;">Explorer</span></div>
    <div class="box lead">Search the stock you wanted.</div>
    <div class="box">
        <input class="keyword" type="text" name="keyword" id="keyword" placeholder="Keying The Keyword" />
        <input class="search" type="button" name="search" id="search" value="Search!" />
    </div>

</div>
<br />
<div id="total_float">
    <div id="total_grade"></div>
</div>
<div id="E_row" class="row">
    <div class="col-md-4 col-xs-6">
        <div class="info_box">
            <div class="show_edfri">E</div>
            <p class="title">- EPS -</p>
            <p class="describe">EPS每一股淨賺多少錢</p>
            <div class="detail">
                <a href="#" class="detail" data-toggle="modal" data-target="#detail_Model">View</a>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-xs-6">
        <div class="info_detail row">
            <div class="grade col-md-6 col-sm-12 col-xs-12">0</div>
            <div class="rule col-md-6 hidden-sm hidden-xs">
                <ul>
                    <li>10年穩定增加EPS</li>
                    <li>當年度增加就加1</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div id="D_row" class="row">
    <div class="col-md-4 col-xs-6">
        <div class="info_box">
            <div class="show_edfri">D</div>
            <p class="title">- DIVIDEND -</p>
            <p class="describe">證明公司已經有錢給你</p>
            <div class="detail">
                <a href="#" class="detail" data-toggle="modal" data-target="#detail_Model">View</a>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-xs-6">
        <div class="info_detail row">
            <div class="grade col-md-6 col-sm-12 col-xs-12">0</div>
            <div class="rule col-md-6 hidden-sm hidden-xs">
                <ul>
                    <li>股息/EPS，每年穩定發放股息</li>
                    <li>當年度增加就加1</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div id="F_row" class="row">
    <div class="col-md-4 col-xs-6">
        <div class="info_box">
            <div class="show_edfri">F</div>
            <p class="title">- Free Cash Flow -</p>
            <p class="describe">穩定現金流</p>
            <div class="detail">
                <a href="#" class="detail" data-toggle="modal" data-target="#detail_Model">View</a>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-xs-6">
        <div class="info_detail row">
            <div class="grade col-md-6 col-sm-12 col-xs-12">0</div>
            <div class="rule col-md-6 hidden-sm hidden-xs">
                <ul>
                    <li>10年自由現金流持續為正數</li>
                    <li>當年度增加就加1</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div id="R_row" class="row">
    <div class="col-md-4 col-xs-6">
        <div class="info_box">
            <div class="show_edfri">R</div>
            <p class="title">- ROE -</p>
            <p class="describe">賺錢的效率</p>
            <div class="detail">
                <a href="#" class="detail" data-toggle="modal" data-target="#detail_Model">View</a>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-xs-6">
        <div class="info_detail row">
            <div class="grade col-md-6 col-sm-12 col-xs-12">0</div>
            <div class="rule col-md-6 hidden-sm hidden-xs">
                <ul>
                    <li>10年ROE股東權益報酬率 > 15%</li>
                    <li>當年度增加就加1</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<div id="I_row" class="row">
    <div class="col-md-4 col-xs-6">
        <div class="info_box">
            <div class="show_edfri">I</div>
            <p class="title">- Interest Coverage -</p>
            <p class="describe">還債能力</p>
            <div class="detail">
                <a href="#" class="detail" data-toggle="modal" data-target="#detail_Model">View</a>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-xs-6">
        <div class="info_detail row">
            <div class="grade col-md-6 col-sm-12 col-xs-12">0</div>
            <div class="rule col-md-6 hidden-sm hidden-xs">
                <ul>
                    <li>淨收入/利息，採取最新一年資料</li>
                    <li>> 10得10分；> 4得5分</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="over" class="overLoading"></div>
<div id="layout" class="layoutLoading"><img src="/Images/loading.gif" /></div>

<!-- Modal -->
<div id="detail_Model" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body">
                <canvas id="stockDataChart" width="400" height="400"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
